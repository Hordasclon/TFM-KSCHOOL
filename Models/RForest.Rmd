---
title: "Random Forest"
author: "Marcos Mariscal"
date: "23/5/2021"
output: html_document
---
```{r setup, include=FALSE}

# Getting project directory 
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
proydir <- rprojroot::find_rstudio_root_file()

```

---
# Calling R libraries
---

```{r call_libraries, include=FALSE}

# Calling R libraries
library(randomForest)
library(tidyverse)
library(MLmetrics)
```

---
## Enviroment variables definition
---

```{r envdefs, include=FALSE}
#Environment directories vars
airfilepath="./Data/Air_Quality/"
pngpath="./png/"
datapath="./Data/"

# Defining file names variables to load the data
file_TotRespData = "TotRespData.Rdata"

```



```{r Load_TotAgg, echo=FALSE}
# Read AQI Visits
load(file = paste(datapath,file_TotRespData, sep=""))
TotRespData

```

Getting only numeric Features for Respiratory ilnesses

```{r numeric}

NumDataResp <- TotRespData[,8:26]

```

---
# Normalization the Data
---
Z-score normalization, consists of subtracting the mean and divide by the standard deviation
We normalize the data to bring all the variables to the same range

```{r norm}
means <- colMeans(NumDataResp)
sds <- apply(NumDataResp, 2, sd)

z_NumDataResp <- scale(NumDataResp, center = means, scale = sds)

z_NumDataResp <- as_tibble(z_NumDataResp)

colnames(z_NumDataResp)

head(z_NumDataResp)

```


##Splitting data into test and train
The following code splits 70% of the data selected randomly into training set and the remaining 30% sample into test data set

```{r splitting}

set.seed(111)
dt = sort(sample(nrow(NumDataResp), nrow(NumDataResp)*.7))
train<-z_NumDataResp[dt,]
test<-z_NumDataResp[-dt,]

```


```{r RForest}

#+RSP008_chronic_pulmonary+RSP009_asthma+RSP010_aspiration_pneumonitis+RSP012_respiratory_failure+Use_mech_ventilation+RateRespVisits+TotResp+POPULATION

set.seed(222)
rf <- randomForest(AQI ~ Ages_0_4+Ages_5_9+Ages_10_17+Ages_18_44+Ages_45_64+Ages_65_79+Ages_80+RSP002_pneumonia+RSP005_acute_bronchitis+RSP008_chronic_pulmonary+RSP009_asthma+RSP010_aspiration_pneumonitis+RSP012_respiratory_failure+Use_mech_ventilation+RateRespVisits+TotResp, data = train,
                   mtry =10,
                   ntree = 50,
                   proximity=F)

```


```{r summary}
summary(rf)
print(rf)
```

```{r predict}
predict1 <- predict(rf, test)
RMSE(predict1, test$AQI)
```

# RMSE value â‰¥0.5 reflects the poor ability of the model to accurately predict the data.
This RMSE value (0.91) is worse than the Base Line one (0.84)

Now visualize original test and predicted data in a plot

```{r visual}

pre <- predict1
act <- test$AQI
t1 <- cbind(pre,act)

x = 1:length(t1[,1])
plot(x, t1[,1], col = "red", type = "l")
lines(x, t1[,2], col = "blue", type = "l")
legend(x = 70, y=3.4,  legend = c("original values", "predicted values"), 
       col = c("red", "blue"), box.lty = 2, cex = 0.8, lty = c(1, 1))
```


```
#Plotting Model
```{r plotmodel}
plot(rf, log="y")
```

