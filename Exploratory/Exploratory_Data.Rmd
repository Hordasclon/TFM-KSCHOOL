---
title: "Exploratory_Data_Analysis"
author: "Marcos Mariscal"
date: "23/5/2021"
output: html_document
---


```{r setup, include=FALSE}

# Getting project directory 
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
proydir <- rprojroot::find_rstudio_root_file()
```


#### This RMarkdown __merge__ all data and represent different graphs to visualice relation with features


```{r call_libraries, include=FALSE}
# Calling R libraries
library(tidyverse)
library (tools)
library(dplyr)
library (ggplot2)
library(sf)
library(ggrepel)
require(gridExtra)
library(RColorBrewer)
library(cowplot)

```


```{r envdefs, include=FALSE}
## Enviroment variables definition
airfilepath="./Data/Air_Quality/"
pngpath="./png/"
datapath="./Data/"

# Defining file names variables to load the data
file_aqi_saved = "Air_Quality_Indexes.Rdata"
file_visits_saved = "Hosp_visits_pop_by_state.Rdata"
file_TotData_save = "TotData.Rdata"

Years = c(2017,2018,2019,2020)
```

---

### Loading Air QUality Indexes Data and Hospital Visits $ Emergencies population at State level with geographical data

---

This first DataSet has been generated with the DataCleasing R Notebook


```{r Load_AirQ, echo=FALSE}
# Read AQI Visits
load(file = paste(datapath,file_aqi_saved, sep=""))
head(Air_Quality_Indexes)

```

---

### Loading Hospital Visits & Emergencies and the whole population at USA State level with geographical data

---

This second DataSet has been also generated with the DataCleasing R Notebook

```{r Load_HospVisits, echo=FALSE}
# Read Hospital Visits
load(file = paste(datapath,file_visits_saved, sep=""))
head(Hosp_visits_pop_by_state)
#utils::View(Hosp_visits_pop_by_state)

```

---

To prepare the merging of DataSets 1 and 2 we should first aggregate AQI data by US State and month, having media from: Cat, AQI

```{r AQI_Group_By_State, include=FALSE}

# Air Quality Indexes Grouped by State and month, having median from: Cat, AQI
# maintaining Defining.Parameter: PM2.5, Ozone, CO, NO2, PM10, SO2
# AQI index is de maximum index of analyzed component AQI = max( AQIPM2.5, AQIPM10, AQIO3, ...)
    

     Airaggdf1 <- Air_Quality_Indexes %>% select (State.Name, yearmm, Cat,AQI)  %>% group_by(State.Name, yearmm) %>% summarize(Cat = ceiling(mean(Cat)), AQI = ceiling(mean(AQI)))

# Match description with numeric values for the AQI categories:      
    Airaggdf1$Category <- ifelse(Airaggdf1$Cat==1,"Good",ifelse(Airaggdf1$Cat==2,"Moderate",ifelse(Airaggdf1$Cat==3,"Unhealthy for Sensitive Groups",ifelse(Airaggdf1$Cat==4,"Unhealthy",ifelse(Airaggdf1$Cat==5,"Very Unhealthy",ifelse(Airaggdf1$Cat==6,"Hazardous","Raro")))))) 

AQI_State_Group <- Airaggdf1
AQI_State_Group <- rename(AQI_State_Group, "STATES"="State.Name")
AQI_State_Group <- rename(AQI_State_Group, "Dates"="yearmm")

```


```{r Merge_Data, include=FALSE}

# Merge for Air Quality data and Hospital Visits group by USA State. With geographical data

TotData_1 <- full_join(x = AQI_State_Group, y =Hosp_visits_pop_by_state , by = c("STATES","Dates"))

#Convert to numeric

TotData_1$REGION <- as.numeric(TotData_1$REGION)

# Generating a Tibble for USA States abbreviations and regions

statesabbs<- as_tibble(state.name)
statesabbs$statabb<-state.abb
statesabbs$statreg<-state.region

# Rename value column to STATES
names(statesabbs)[names(statesabbs) == "value"] <- "STATES"

# Including States abbreviations and regions in TOTAL data
TotData_2 <- merge(x = TotData_1, y = statesabbs, by= "STATES", all.x = TRUE)

#removing records with No Hospital Visits data
Tot_no_null = TotData_2 %>% filter(!is.na(All_discharges))

#removing records with No AQI data
Tot_no_null = Tot_no_null %>% filter(!is.na(AQI))

#For representing data, we need to transform null in zeros
Tot_no_null<- Tot_no_null%>%mutate_if(is.numeric, funs(replace_na(., 0)))

#Generate month field in order to get monthly group data

TotData <- Tot_no_null%>%mutate(MONTH= as.integer(format(Dates, "%m")))
#utils::View(TotData)

```

```{r TOTAggMonth, include=FALSE}

TotData <- mutate(TotData,TotResp=RSP002_pneumonia+RSP005_acute_bronchitis+RSP008_chronic_pulmonary+RSP009_asthma+RSP010_aspiration_pneumonitis+ RSP012_respiratory_failure)

#Total Hospital Visits with respiratory diseases vs Population ratio
TotData <- TotData%>%mutate(RateRespVisits= (TotResp/POPULATION))

# Total Monthly Data to plot the most Hops. Visits by STATE

MonthData<- TotData %>%select(STATES,MONTH,statreg,statabb,TotResp,POPULATION,AQI,RateRespVisits) %>% group_by(STATES,MONTH,statreg,statabb) %>% summarize(mnPop=mean(POPULATION),mnTotResp=mean(TotResp),mnRateRespVisits=mean(RateRespVisits),mnAQI=mean(AQI))

```

```{r TOTggplot, include=FALSE}
### This ggplot graph is to analyze the different State data for Hospital visits with respiratory diseases
f_visits_graphs <- for (i in 1:12){ 
  
  PartMonthData<- MonthData %>%select(MONTH,statreg,statabb,mnPop,mnTotResp) %>%filter(MONTH== i)
  
  #Plotting Hospitals Visits vs USA data states points

  Visit_graph <- PartMonthData%>% ggplot()+
    geom_point(aes(x =mnPop/10^6, y =mnTotResp, col=statreg),size = 2) + 
    geom_text_repel(aes(mnPop/10^6, mnTotResp, label = statabb), nudge_x = -0.1,nudge_y = 0.1)+
    scale_x_continuous(trans = "log10") +scale_y_continuous(trans = "log10")+ 
    ylab("Total Hospital Visits with respiratory diseases (log scale)") +
    xlab(" (Population (log scale)") +
    ggtitle(paste("Hospital Visits with respiratory diseases, in USA States for ",month.name[i],sep=""))+
    scale_color_discrete(name = "Region")
  
  #Including average line to refer the distance from it with the States Hosp.visits with respiratory diseases
  
  avline <- PartMonthData %>%  summarize(rate = sum(mnTotResp)/ sum(mnPop) * 10^6)  %>% pull(rate)
  
  line <- mean(unlist(avline))
  
  grapth <- Visit_graph + geom_abline(intercept = log10(line), lty = 2, color = "darkgrey")
  
  assign(paste("Visits_g",i,sep=""), (grapth))
}

```

---

### Visual analysis for Hospital visits with respiratory diseases aggretated Data by Month
For January Data

```{r Janggplot1, fig.show="hold", out.width="120%"}

Visits_g1

```

---

### Visual analysis for Hospital visits with respiratory diseases aggretated Data by Month
For April Data

```{r Janggplot2, fig.show="hold", out.width="120%"}

Visits_g4

```


We can see that in general there are a few US State far from median line

### Now plotting states and Hosp.Visit rates by Month

```{r States_HospV ,include=FALSE}

 for (i in 1:12) {
   # Filtering Data by Month 
   PartMonthData<- MonthData %>%select(STATES,MONTH,statreg,statabb,mnPop,mnTotResp,mnRateRespVisits) %>%filter(MONTH== i)

       #Arrange Data by Hospital visits vs Population rate
    PartMonthData <-PartMonthData %>% arrange(-mnRateRespVisits)
    StatesOrd <- PartMonthData$STATES
    
    getPalette <- colorRampPalette(brewer.pal(9, "Set1"))(44)

    
    states_graph <-  ggplot(data=PartMonthData, aes(x=reorder(STATES,-mnRateRespVisits), y=mnRateRespVisits,fill=STATES)) +  
     geom_bar(stat="identity", width=0.8) +  
     theme(axis.text.x = element_blank(),aspect.ratio=6/4 )+ xlab("Usa States")+ ylab("Hospital visits vs Population rate")+ 
     scale_fill_manual(labels=StatesOrd,values =getPalette,name = "States Ordered by Hosp.Visits rate" )+
     ggtitle(paste("Usa States ordered by Hosp.Visits vs Population rate at ",month.name[i],sep=""))+
     theme(plot.title = element_text(vjust = 0),legend.key.size = unit(0.4, "cm"),legend.key.width = unit(0.4,"cm") )+
     scale_y_continuous(limits=c(0,0.00099))
    
   assign(paste("states_graph_",i,sep=""), (states_graph))
 }

```

```{r States_HospV_graph}
states_graph_1
states_graph_2
states_graph_3
states_graph_4
states_graph_5
states_graph_6
states_graph_7
states_graph_8
states_graph_9
states_graph_10
states_graph_11
states_graph_12
```

We can see that 10 Sates always repeat with high rates of Hosp.Visits each year from 2017 to 2020

### Analyzing Air Quality Data on USA States
Standard deviation and mean rate of Air Quality Indexes per month and USA States


```{r AQI graph1 ,include=FALSE}

#utils::View(TotData)

 for (i in 1:12) {
   # Filtering Data by Month 
    partmonthdata <- MonthData%>%select(statabb,MONTH,mnRateRespVisits,mnAQI)%>%filter(MONTH== i)
    partmonthdata$mnRateRespVisits <- partmonthdata$mnRateRespVisits*10^5
   
    #Arrange Data by Hospital visits  vs Population rate

    StatesOrd <- partmonthdata$STATES
    
    partmonthdata_long <- partmonthdata %>% gather( "Keys", "values",-statabb,-MONTH,-STATES,-statreg)
    
    getPalette <- colorRampPalette(brewer.pal(9, "Set1"))(44)

    states_graph <-  ggplot(data=partmonthdata_long, aes(x=reorder(statabb,-values), y = values, fill = Keys)) +  
    geom_bar(stat="identity", position = 'stack', width=0.9) +  
    theme(aspect.ratio=4/8 )+ xlab("Usa States")+ ylab("Hospital visits ratio (10^5)")+ 
    ggtitle(paste("Hosp.Visits ratio vs Air Quality Index",month.name[i],sep=" "))+
    theme(plot.title = element_text(vjust = 0),legend.key.size = unit(0.4, "cm"),legend.key.width = unit(0.4,"cm") )+
    scale_y_continuous( sec.axis = sec_axis(~ . * 1000, name = "Air Quality Index"))+
    scale_x_discrete(guide = guide_axis(n.dodge=3))
    
   assign(paste("states_tot_",i,sep=""), (states_graph))
 }
```

### Presenting Hospital Visits rate vs Air Quality Indexes in all months
 

```{r}
states_tot_1
states_tot_2
states_tot_3
states_tot_4
states_tot_5
states_tot_6
states_tot_7
states_tot_8
states_tot_9
states_tot_10
states_tot_11
states_tot_12
```

Its is clear than there is a correlation between Hospital Visits ratio and the Air Quality Index every month of the year
Saving Aggregated Data for the next Notebook

```{r saving_data}
# Saving in a data file the Tibble with Hospital data Visits and States population:
save(TotData, file = paste(datapath,file_TotData_save,sep=""))
```