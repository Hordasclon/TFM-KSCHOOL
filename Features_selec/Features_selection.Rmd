---
title: "Features selecction"
author: "Marcos Mariscal"
date: "23/5/2021"
output: html_document
---
```{r setup, include=FALSE}

# Getting project directory 
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
proydir <- rprojroot::find_rstudio_root_file()

```

---
# Calling R libraries
---

```{r call_libraries, include=FALSE}

# Calling R libraries
library(tidyverse)
library(R.utils)
library(mice)
library(patchwork)
#library(Hmisc). Not Compatible with Summarize function
library(PerformanceAnalytics)
library(corrplot)

```

---
## Enviroment variables definition
---
```{r envdefs, include=FALSE}
#Environment directories vars
airfilepath="./Data/Air_Quality/"
pngpath="./png/"
datapath="./Data/"

# Defining file names variables to load and save the data
file_TotData = "TotData.Rdata"
file_TotRespData_save = "TotRespData.Rdata"
```

Loading Data field of Hosp.Visits and AQI data

```{r Load_TotAgg, echo=FALSE}
# Read AQI Visits
load(file = paste(datapath,file_TotData, sep=""))
head(TotData)
# utils::View(TotData)
```

# Replace Zeros to NA for all numeric columns

```{r TotRespData, include=FALSE}

TotRespData <- TotData%>%select(STATES,statabb,Dates, MONTH, statreg, AQI, Cat,Category,All_discharges, POPULATION, TotResp, RateRespVisits, RSP002_pneumonia, RSP008_chronic_pulmonary, RSP012_respiratory_failure, RSP005_acute_bronchitis, RSP009_asthma, RSP010_aspiration_pneumonitis, Ages_0_4, Ages_5_9,  Ages_10_17,  Ages_18_44 , Ages_45_64,  Ages_65_79,  Ages_80, Use_mech_ventilation)
```


```{r replace, include=FALSE}

TotRespData <- TotRespData %>% mutate_at(vars(-c(STATES,statabb,Dates, MONTH, statreg, AQI, Cat,Category)), ~replace(., isZero(.), NA))

```

Count the number of the NA values

```{r zeros, include=FALSE}
Num_NA <- sapply(TotRespData, function(y) length(which(is.na(y) == T)))
NA_Count <- data.frame(Item = colnames(TotRespData), Count = Num_NA)
NA_Count
```





```{r pmm, include=FALSE,echo=FALSE}
# To complete NA values, we will use predictive mean matching (pmm) (multi nominal logistic regression)

DataCompl <- TotRespData%>%select (statabb,Dates,MONTH,Ages_0_4, Ages_5_9, Ages_10_17, Ages_18_44, RSP005_acute_bronchitis, RSP002_pneumonia, RSP009_asthma, RSP010_aspiration_pneumonitis,Use_mech_ventilation)

impute <- mice(DataCompl, m = 5, seed = 153)

impute$imp$Ages_0_4
impute$imp$Ages_5_9
impute$imp$Ages_10_17
impute$imp$Ages_18_44
impute$imp$RSP002_pneumonia
impute$imp$RSP005_acute_bronchitis
impute$imp$RSP009_asthma
impute$imp$RSP010_aspiration_pneumonitis
impute$imp$Use_mech_ventilation

Completed <- complete(impute, 2)

```

# Distribution of imputed values with observed ones for Hosp.visits per age ranges

```{r Age_Ranges, fig.show="hold", out.width="50%"}
p1 <- ggplot(Completed) + geom_point(aes(statabb,Ages_0_4))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "USA States")+ 
    ggtitle("Hosp.Visits in Ages ranges")
p2 <- ggplot(Completed) + geom_point(aes(statabb,Ages_5_9))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "USA States")+
    ggtitle("Hosp.Visits in ages ranges")
p3 <- ggplot(Completed) + geom_point(aes(statabb,Ages_10_17))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "USA States")+
    ggtitle("Hosp.Visits in ages ranges")
p4 <- ggplot(Completed) + geom_point(aes(statabb,Ages_18_44))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "USA States")+
    ggtitle("Hosp.Visits in ages ranges")
p1 + p2 + p3 + p4
```

# Distribution of imputed values with observed ones for different respiratori ilnesses

```{r Respiratory, fig.show="hold", out.width="50%"}
p5 <-  ggplot(Completed) + geom_point(aes(MONTH,RSP002_pneumonia))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p6 <-  ggplot(Completed) + geom_point(aes(MONTH,RSP005_acute_bronchitis))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p7 <-  ggplot(Completed) + geom_point(aes(MONTH,RSP009_asthma))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p8 <-  ggplot(Completed) + geom_point(aes(MONTH,RSP010_aspiration_pneumonitis))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p9 <-  ggplot(Completed) + geom_point(aes(MONTH,Use_mech_ventilation))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p5 + p6 + p7 + p8 + p9

```


```{r}

AggTotT1 <- TotRespData%>%select (-c(MONTH,Ages_0_4, Ages_5_9, Ages_10_17, Ages_18_44, RSP005_acute_bronchitis, RSP002_pneumonia, RSP009_asthma, RSP010_aspiration_pneumonitis,Use_mech_ventilation))
TotRespData <- inner_join(x = AggTotT1, y =Completed , by = c("statabb","Dates"))

TotRespData<- TotRespData%>%select(STATES,statabb,Dates,MONTH,statreg,Category,Cat,AQI,Ages_0_4, Ages_5_9, Ages_10_17, Ages_18_44, Ages_45_64,Ages_65_79, Ages_80, RSP002_pneumonia, RSP005_acute_bronchitis, RSP008_chronic_pulmonary,  RSP009_asthma, RSP010_aspiration_pneumonitis, RSP012_respiratory_failure, Use_mech_ventilation, RateRespVisits, TotResp, POPULATION, All_discharges)

```



```{r corrmatrix }
#Correlation for Air Quality Index and all Hospital Visits of Respiratory illness
# ensure the results are repeatable
set.seed(7)

# calculate correlation aggtotd
correlationMatrix <- cor(TotRespData[,8:26])
correlationMatrix
```


```{r corrgraph}
chart.Correlation(TotRespData[,9:26], histogram = T, pch = 19)

```
```{r corrnumbers,  fig.show="hold",out.width="120%"}
corrplot(correlationMatrix, method="number")
```

#coefficients whose magnitude are between 0.3 and 0.5 indicate variables which have a low correlation
```{r printheat, out.width="50%"}
palette = colorRampPalette(c("blue", "white", "red")) (20)
heatmap(x = correlationMatrix, col = palette, symm = TRUE)
```

```{r printcorr1,  fig.show="hold",out.width="120%"}

c1<-corrplot(correlationMatrix, method="circle")
c2<-corrplot(correlationMatrix, method="pie")
c3<-corrplot(correlationMatrix, method="number")
c4<-corrplot(correlationMatrix, method="square")

```


```{r saving_data}
# Saving in a data file the Tibble with Hospital data Visits only with Respiratory ilnesses and AQI data by USA States:
save(TotRespData, file = paste(datapath,file_TotRespData_save,sep=""))

```