---
title: "Features selecction"
author: "Marcos Mariscal"
date: "23/5/2021"
output: html_document
---
```{r setup, include=FALSE}

# Getting project directory 
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
proydir <- rprojroot::find_rstudio_root_file()

```

---
# Calling R libraries
---

```{r call_libraries, include=FALSE}

# Calling R libraries
library(tidyverse)
library(R.utils)
library(mice)
library(patchwork)
library(Hmisc)
library(PerformanceAnalytics)
library(corrplot)

```

---
## Enviroment variables definition
---
```{r envdefs, include=FALSE}
#Environment directories vars
airfilepath="./Data/Air_Quality/"
pngpath="./png/"
datapath="./Data/"

# Defining file names variables to load the data
file_AggTotData = "AggTotData.Rdata"
file_TotRespData="TotRespData.Rdata"
```



```{r Load_TotAgg, echo=FALSE}
# Read AQI Visits
load(file = paste(datapath,file_AggTotData, sep=""))
head(AggTotData)
# utils::View(AggTotData)
```

# Replace Zeros to NA for all numeric columns

```{r replace, include=FALSE}

AggTotData <- AggTotData %>% mutate_at(vars(-c(STATES,MONTH,statreg,statabb)), ~replace(., isZero(.), NA))

```

Count the number of the NA values

```{r zeros, include=FALSE}
Num_NA <- sapply(AggTotData, function(y) length(which(is.na(y) == T)))
NA_Count <- data.frame(Item = colnames(AggTotData), Count = Num_NA)
NA_Count

```
```{r pmm, include=FALSE,echo=FALSE}
# To complete NA values, we will use predictive mean matching (pmm) (multi nominal logistic regression)
DataCompl <- AggTotData%>%select (STATES,MONTH,statreg,statabb,mnAges0_4,
                                    mnAges5_9,mnAges10_17,mnAges18_44,mnResL,mnVent,mnSepti,mnBron,mnAsthma,mnAsp)
impute <- mice(DataCompl, m = 5, seed = 153)

impute$imp$mnAges0_4
impute$imp$mnAges5_9
impute$imp$mnAges10_17
impute$imp$mnAges18_44
impute$imp$mnResL
impute$imp$mnVent
impute$imp$mnSepti
impute$imp$mnBron
impute$imp$mnAsthma
impute$imp$mnAsp

Completed <- complete(impute, 2)

```

# Distribution of imputed values with observed ones for Hosp.visits per age ranges

```{r Age_Ranges, fig.show="hold", out.width="50%"}
p1 <- ggplot(Completed) + geom_point(aes(statabb,mnAges0_4))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "USA States")+ 
    ggtitle("Hosp.Visits in ages ranges")
p2 <- ggplot(Completed) + geom_point(aes(statabb,mnAges5_9))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "USA States")+
    ggtitle("Hosp.Visits in ages ranges")
p3 <- ggplot(Completed) + geom_point(aes(statabb,mnAges10_17))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "USA States")+
    ggtitle("Hosp.Visits in ages ranges")
p4 <- ggplot(Completed) + geom_point(aes(statabb,mnAges18_44))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "USA States")+
    ggtitle("Hosp.Visits in ages ranges")
p1 + p2 + p3 + p4
```

# Distribution of imputed values with observed ones for different respiratori ilnesses

```{r Respiratory, fig.show="hold", out.width="50%"}
p5 <-  ggplot(Completed) + geom_point(aes(MONTH,mnVent))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p6 <-  ggplot(Completed) + geom_point(aes(MONTH,mnSepti))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p7 <-  ggplot(Completed) + geom_point(aes(MONTH,mnBron))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p8 <-  ggplot(Completed) + geom_point(aes(MONTH,mnAsthma))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p9 <-  ggplot(Completed) + geom_point(aes(MONTH,mnAsp))+
    scale_x_discrete(guide = guide_axis(n.dodge=3), name = "Months")+
    ggtitle("Hospital Visits")
p5 + p6 + p7 + p8 + p9

```


```{r}

AggTotT1 <- AggTotData%>%select (-c(statabb,mnAges0_4, mnAges5_9,mnAges10_17,mnAges18_44,mnResL,mnVent,mnSepti,mnBron,mnAsthma,mnAsp))
TotData <- inner_join(x = AggTotT1, y =Completed , by = c("STATES","MONTH","statreg"))

TotData <- TotData%>%mutate(rateRespVisits= (mnTotResp/mnPop))

TotRespData <- TotData%>%select(STATES,statabb, MONTH, statreg, mnAQI, mncat, mnPop, mnTotResp, rateRespVisits, mnPneum, mnPulm, mnResp, mnBron, mnAsthma, mnAsp)

TotRespData%>%rename( RSP002_pneumonia= mnPneum,RSP005_acute_bronchitis=mnBron, RSP008_chronic_pulmonary=mnPulm, RSP009_asthma=mnAsthma, RSP010_aspiration_pneumonitis=mnAsp,  RSP012_respiratory_failure=mnResp)

```



```{r corrmatrix }
#Correlation for Air Quality Index and all Hospital Visits of Respiratory illness
# ensure the results are repeatable
set.seed(7)

# calculate correlation aggtotd
correlationMatrix <- cor(TotRespData[,5:15])
correlationMatrix
```


```{r corrgraph}
correlationtest <- rcorr(as.matrix(TotRespData[,5:15]))

chart.Correlation(TotRespData[,5:15], histogram = T, pch = 19)

```
```{r corrnumbers,  fig.show="hold",out.width="100%"}
corrplot(correlationMatrix, method="number")
```

#coefficients whose magnitude are between 0.3 and 0.5 indicate variables which have a low correlation
```{r printheat, out.width="50%"}
palette = colorRampPalette(c("blue", "white", "red")) (20)
heatmap(x = correlationMatrix, col = palette, symm = TRUE)
```

```{r printcorr,  fig.show="hold",out.width="120%"}

par(mfrow=c(2,2))

c1<-corrplot(correlationMatrix, method="circle")
c2<-corrplot(correlationMatrix, method="pie")
c3<-corrplot(correlationMatrix, method="number")
c4<-corrplot(correlationMatrix, method="square")

```

```{r saving_data}
# Saving in a data file the Tibble with Hospital data Visits only with Respiratory ilnesses and AQI data by USA States:
save(TotRespData, file = paste(datapath,file_TotRespData,sep=""))
```